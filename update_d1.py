import baostock as bs
import pandas as pd
import datetime
import os

# Configuration
OUTPUT_SQL_FILE = "update.sql"

def get_today_date():
    return datetime.datetime.now().strftime("%Y-%m-%d")

def get_constituents():
    return [
        'sh.600000', 'sh.600004', 'sh.600006', 'sh.600007', 'sh.600008', 'sh.600009', 'sh.600010', 'sh.600011', 'sh.600015', 'sh.600016', 'sh.600018', 'sh.600019', 'sh.600021', 'sh.600023', 'sh.600025', 'sh.600026', 'sh.600027', 'sh.600028', 'sh.600029', 'sh.600030', 'sh.600031', 'sh.600032', 'sh.600036', 'sh.600038', 'sh.600039', 'sh.600048', 'sh.600050', 'sh.600056', 'sh.600060', 'sh.600061', 'sh.600062', 'sh.600079', 'sh.600085', 'sh.600089', 'sh.600095', 'sh.600096', 'sh.600098', 'sh.600100', 'sh.600104', 'sh.600109', 'sh.600111', 'sh.600115', 'sh.600118', 'sh.600126', 'sh.600131', 'sh.600132', 'sh.600141', 'sh.600143', 'sh.600150', 'sh.600153', 'sh.600155', 'sh.600157', 'sh.600160', 'sh.600161', 'sh.600166', 'sh.600170', 'sh.600171', 'sh.600176', 'sh.600177', 'sh.600183', 'sh.600188', 'sh.600196', 'sh.600208', 'sh.600219', 'sh.600233', 'sh.600256', 'sh.600258', 'sh.600271', 'sh.600276', 'sh.600282', 'sh.600295', 'sh.600298', 'sh.600299', 'sh.600305', 'sh.600309', 'sh.600312', 'sh.600316', 'sh.600325', 'sh.600329', 'sh.600332', 'sh.600339', 'sh.600346', 'sh.600348', 'sh.600352', 'sh.600361', 'sh.600362', 'sh.600363', 'sh.600369', 'sh.600373', 'sh.600378', 'sh.600380', 'sh.600383', 'sh.600390', 'sh.600392', 'sh.600398', 'sh.600406', 'sh.600409', 'sh.600415', 'sh.600418', 'sh.600426', 'sh.600435', 'sh.600436', 'sh.600438', 'sh.600460', 'sh.600483', 'sh.600486', 'sh.600487', 'sh.600489', 'sh.600497', 'sh.600498', 'sh.600499', 'sh.600511', 'sh.600516', 'sh.600517', 'sh.600519', 'sh.600521', 'sh.600522', 'sh.600528', 'sh.600529', 'sh.600535', 'sh.600536', 'sh.600546', 'sh.600547', 'sh.600549', 'sh.600559', 'sh.600562', 'sh.600563', 'sh.600566', 'sh.600570', 'sh.600578', 'sh.600580', 'sh.600582', 'sh.600583', 'sh.600584', 'sh.600585', 'sh.600588', 'sh.600598', 'sh.600600', 'sh.600606', 'sh.600612', 'sh.600637', 'sh.600655', 'sh.600660', 'sh.600663', 'sh.600673', 'sh.600674', 'sh.600685', 'sh.600688', 'sh.600690', 'sh.600699', 'sh.600703', 'sh.600704', 'sh.600707', 'sh.600720', 'sh.600732', 'sh.600733', 'sh.600737', 'sh.600739', 'sh.600741', 'sh.600745', 'sh.600754', 'sh.600760', 'sh.600763', 'sh.600764', 'sh.600765', 'sh.600795', 'sh.600801', 'sh.600803', 'sh.600808', 'sh.600809', 'sh.600816', 'sh.600820', 'sh.600839', 'sh.600845', 'sh.600848', 'sh.600859', 'sh.600862', 'sh.600863', 'sh.600867', 'sh.600871', 'sh.600872', 'sh.600873', 'sh.600875', 'sh.600879', 'sh.600884', 'sh.600885', 'sh.600886', 'sh.600887', 'sh.600893', 'sh.600895', 'sh.600900', 'sh.600901', 'sh.600906', 'sh.600909', 'sh.600918', 'sh.600919', 'sh.600925', 'sh.600926', 'sh.600927', 'sh.600928', 'sh.600938', 'sh.600941', 'sh.600956', 'sh.600958', 'sh.600959', 'sh.600968', 'sh.600970', 'sh.600977', 'sh.600985', 'sh.600988', 'sh.600989', 'sh.600995', 'sh.600998', 'sh.600999', 'sh.601000', 'sh.601001', 'sh.601006', 'sh.601009', 'sh.601012', 'sh.601016', 'sh.601019', 'sh.601021', 'sh.601058', 'sh.601061', 'sh.601066', 'sh.601088', 'sh.601098', 'sh.601099', 'sh.601100', 'sh.601106', 'sh.601108', 'sh.601111', 'sh.601117', 'sh.601118', 'sh.601127', 'sh.601128', 'sh.601136', 'sh.601138', 'sh.601139', 'sh.601155', 'sh.601156', 'sh.601158', 'sh.601162', 'sh.601166', 'sh.601168', 'sh.601169', 'sh.601179', 'sh.601186', 'sh.601198', 'sh.601211', 'sh.601212', 'sh.601216', 'sh.601225', 'sh.601228', 'sh.601229', 'sh.601231', 'sh.601233', 'sh.601236', 'sh.601238', 'sh.601288', 'sh.601318', 'sh.601319', 'sh.601328', 'sh.601333', 'sh.601336', 'sh.601360', 'sh.601377', 'sh.601390', 'sh.601398', 'sh.601399', 'sh.601456', 'sh.601555', 'sh.601568', 'sh.601577', 'sh.601598', 'sh.601600', 'sh.601601', 'sh.601607', 'sh.601608', 'sh.601611', 'sh.601615', 'sh.601618', 'sh.601628', 'sh.601633', 'sh.601636', 'sh.601658', 'sh.601665', 'sh.601666', 'sh.601668', 'sh.601669', 'sh.601688', 'sh.601689', 'sh.601696', 'sh.601698', 'sh.601699', 'sh.601700', 'sh.601702', 'sh.601717', 'sh.601718', 'sh.601727', 'sh.601728', 'sh.601766', 'sh.601778', 'sh.601788', 'sh.601798', 'sh.601799', 'sh.601800', 'sh.601808', 'sh.601816', 'sh.601818', 'sh.601825', 'sh.601827', 'sh.601838', 'sh.601857', 'sh.601858', 'sh.601860', 'sh.601865', 'sh.601866', 'sh.601868', 'sh.601872', 'sh.601877', 'sh.601878', 'sh.601880', 'sh.601881', 'sh.601888', 'sh.601898', 'sh.601899', 'sh.601901', 'sh.601916', 'sh.601918', 'sh.601919', 'sh.601921', 'sh.601928', 'sh.601933', 'sh.601939', 'sh.601958', 'sh.601965', 'sh.601966', 'sh.601985', 'sh.601988', 'sh.601989', 'sh.601990', 'sh.601991', 'sh.601995', 'sh.601997', 'sh.601998', 'sh.603000', 'sh.603019', 'sh.603077', 'sh.603087', 'sh.603129', 'sh.603156', 'sh.603160', 'sh.603179', 'sh.603195', 'sh.603225', 'sh.603228', 'sh.603233', 'sh.603259', 'sh.603260', 'sh.603288', 'sh.603290', 'sh.603296', 'sh.603298', 'sh.603338', 'sh.603341', 'sh.603345', 'sh.603369', 'sh.603379', 'sh.603392', 'sh.603486', 'sh.603501', 'sh.603529', 'sh.603556', 'sh.603565', 'sh.603568', 'sh.603589', 'sh.603596', 'sh.603605', 'sh.603606', 'sh.603650', 'sh.603658', 'sh.603659', 'sh.603688', 'sh.603707', 'sh.603728', 'sh.603737', 'sh.603786', 'sh.603799', 'sh.603806', 'sh.603816', 'sh.603826', 'sh.603833', 'sh.603858', 'sh.603868', 'sh.603885', 'sh.603893', 'sh.603899', 'sh.603927', 'sh.603939', 'sh.603979', 'sh.603986', 'sh.603993', 'sh.605117', 'sh.605358', 'sh.605499', 'sh.605589', 'sh.688002', 'sh.688008', 'sh.688009', 'sh.688012', 'sh.688017', 'sh.688027', 'sh.688032', 'sh.688036', 'sh.688041', 'sh.688047', 'sh.688052', 'sh.688065', 'sh.688072', 'sh.688082', 'sh.688099', 'sh.688100', 'sh.688111', 'sh.688114', 'sh.688120', 'sh.688122', 'sh.688126', 'sh.688153', 'sh.688169', 'sh.688172', 'sh.688180', 'sh.688183', 'sh.688187', 'sh.688188', 'sh.688213', 'sh.688220', 'sh.688223', 'sh.688234', 'sh.688235', 'sh.688248', 'sh.688249', 'sh.688256', 'sh.688271', 'sh.688278', 'sh.688281', 'sh.688295', 'sh.688297', 'sh.688301', 'sh.688303', 'sh.688318', 'sh.688349', 'sh.688361', 'sh.688363', 'sh.688375', 'sh.688385', 'sh.688387', 'sh.688396', 'sh.688425', 'sh.688469', 'sh.688472', 'sh.688475', 'sh.688506', 'sh.688520', 'sh.688521', 'sh.688525', 'sh.688538', 'sh.688561', 'sh.688563', 'sh.688568', 'sh.688578', 'sh.688582', 'sh.688599', 'sh.688608', 'sh.688617', 'sh.688676', 'sh.688702', 'sh.688728', 'sh.688772', 'sh.688777', 'sh.688778', 'sh.688819', 'sh.688981', 'sh.689009', 'sz.000001', 'sz.000002', 'sz.000009', 'sz.000021', 'sz.000027', 'sz.000032', 'sz.000034', 'sz.000039', 'sz.000050', 'sz.000060', 'sz.000062', 'sz.000063', 'sz.000066', 'sz.000100', 'sz.000155', 'sz.000157', 'sz.000166', 'sz.000301', 'sz.000333', 'sz.000338', 'sz.000400', 'sz.000403', 'sz.000408', 'sz.000415', 'sz.000423', 'sz.000425', 'sz.000426', 'sz.000429', 'sz.000513', 'sz.000519', 'sz.000528', 'sz.000537', 'sz.000538', 'sz.000539', 'sz.000543', 'sz.000559', 'sz.000563', 'sz.000568', 'sz.000582', 'sz.000591', 'sz.000596', 'sz.000598', 'sz.000617', 'sz.000623', 'sz.000625', 'sz.000629', 'sz.000630', 'sz.000636', 'sz.000651', 'sz.000661', 'sz.000683', 'sz.000703', 'sz.000708', 'sz.000709', 'sz.000723', 'sz.000725', 'sz.000728', 'sz.000729', 'sz.000733', 'sz.000738', 'sz.000739', 'sz.000750', 'sz.000768', 'sz.000776', 'sz.000783', 'sz.000785', 'sz.000786', 'sz.000792', 'sz.000800', 'sz.000807', 'sz.000825', 'sz.000830', 'sz.000831', 'sz.000858', 'sz.000876', 'sz.000878', 'sz.000883', 'sz.000887', 'sz.000893', 'sz.000895', 'sz.000898', 'sz.000921', 'sz.000932', 'sz.000933', 'sz.000937', 'sz.000938', 'sz.000951', 'sz.000958', 'sz.000959', 'sz.000960', 'sz.000963', 'sz.000967', 'sz.000975', 'sz.000977', 'sz.000983', 'sz.000987', 'sz.000988', 'sz.000997', 'sz.000999', 'sz.001213', 'sz.001286', 'sz.001289', 'sz.001389', 'sz.001391', 'sz.001696', 'sz.001965', 'sz.001979', 'sz.002001', 'sz.002007', 'sz.002008', 'sz.002025', 'sz.002027', 'sz.002028', 'sz.002044', 'sz.002049', 'sz.002050', 'sz.002056', 'sz.002064', 'sz.002065', 'sz.002074', 'sz.002078', 'sz.002080', 'sz.002085', 'sz.002120', 'sz.002129', 'sz.002130', 'sz.002138', 'sz.002142', 'sz.002152', 'sz.002153', 'sz.002155', 'sz.002156', 'sz.002179', 'sz.002180', 'sz.002185', 'sz.002195', 'sz.002202', 'sz.002203', 'sz.002223', 'sz.002230', 'sz.002236', 'sz.002241', 'sz.002244', 'sz.002252', 'sz.002261', 'sz.002262', 'sz.002266', 'sz.002273', 'sz.002281', 'sz.002294', 'sz.002299', 'sz.002304', 'sz.002311', 'sz.002312', 'sz.002318', 'sz.002340', 'sz.002352', 'sz.002353', 'sz.002371', 'sz.002372', 'sz.002385', 'sz.002409', 'sz.002410', 'sz.002414', 'sz.002415', 'sz.002422', 'sz.002423', 'sz.002429', 'sz.002430', 'sz.002432', 'sz.002436', 'sz.002439', 'sz.002444', 'sz.002459', 'sz.002460', 'sz.002461', 'sz.002463', 'sz.002465', 'sz.002466', 'sz.002472', 'sz.002475', 'sz.002493', 'sz.002500', 'sz.002507', 'sz.002508', 'sz.002517', 'sz.002532', 'sz.002558', 'sz.002563', 'sz.002568', 'sz.002572', 'sz.002594', 'sz.002595', 'sz.002600', 'sz.002601', 'sz.002603', 'sz.002607', 'sz.002608', 'sz.002624', 'sz.002648', 'sz.002653', 'sz.002670', 'sz.002673', 'sz.002683', 'sz.002709', 'sz.002714', 'sz.002736', 'sz.002738', 'sz.002739', 'sz.002756', 'sz.002773', 'sz.002797', 'sz.002821', 'sz.002831', 'sz.002837', 'sz.002841', 'sz.002850', 'sz.002851', 'sz.002916', 'sz.002920', 'sz.002926', 'sz.002938', 'sz.002939', 'sz.002945', 'sz.002958', 'sz.002966', 'sz.002984', 'sz.003022', 'sz.003031', 'sz.003035', 'sz.003816', 'sz.300001', 'sz.300002', 'sz.300003', 'sz.300012', 'sz.300014', 'sz.300015', 'sz.300017', 'sz.300024', 'sz.300033', 'sz.300037', 'sz.300054', 'sz.300058', 'sz.300059', 'sz.300070', 'sz.300073', 'sz.300115', 'sz.300122', 'sz.300124', 'sz.300136', 'sz.300140', 'sz.300142', 'sz.300144', 'sz.300146', 'sz.300207', 'sz.300212', 'sz.300223', 'sz.300251', 'sz.300274', 'sz.300285', 'sz.300308', 'sz.300316', 'sz.300339', 'sz.300346', 'sz.300347', 'sz.300373', 'sz.300383', 'sz.300390', 'sz.300394', 'sz.300395', 'sz.300408', 'sz.300413', 'sz.300418', 'sz.300433', 'sz.300442', 'sz.300450', 'sz.300454', 'sz.300458', 'sz.300474', 'sz.300476', 'sz.300487', 'sz.300496', 'sz.300498', 'sz.300502', 'sz.300529', 'sz.300558', 'sz.300567', 'sz.300573', 'sz.300595', 'sz.300601', 'sz.300604', 'sz.300623', 'sz.300627', 'sz.300628', 'sz.300661', 'sz.300676', 'sz.300677', 'sz.300679', 'sz.300699', 'sz.300724', 'sz.300735', 'sz.300748', 'sz.300750', 'sz.300751', 'sz.300757', 'sz.300759', 'sz.300760', 'sz.300763', 'sz.300765', 'sz.300782', 'sz.300803', 'sz.300832', 'sz.300857', 'sz.300888', 'sz.300896', 'sz.300919', 'sz.300957', 'sz.300979', 'sz.300999', 'sz.301165', 'sz.301236', 'sz.301267', 'sz.301269', 'sz.301301', 'sz.301308', 'sz.301358', 'sz.301498', 'sz.301536', 'sz.302132'
    ]

def fetch_daily_data(codes, date):
    print(f"Fetching data for {date}...")
    # Note: bs.login() is already called in get_constituents, but safe to call again or check status
    # Baostock session might timeout, so re-login is safer if long time passed, but here it's fast.
    
    all_data = []
    total = len(codes)
    
    for i, code in enumerate(codes):
        if i % 100 == 0:
            print(f"Progress: {i}/{total}")
            
        rs = bs.query_history_k_data_plus(
            code,
            "date,code,open,high,low,close,volume,amount,adjustflag",
            start_date=date,
            end_date=date,
            frequency="d",
            adjustflag="3" 
        )
        
        while (rs.error_code == '0') & rs.next():
            all_data.append(rs.get_row_data())
            
    if not all_data:
        print("No data found for today.")
        return pd.DataFrame()
        
    return pd.DataFrame(all_data, columns=["date", "code", "open", "high", "low", "close", "volume", "amount", "adjustflag"])

def generate_sql(df):
    print(f"Generating SQL for {len(df)} rows...")
    with open(OUTPUT_SQL_FILE, "w") as f:
        for _, row in df.iterrows():
            # Handle potential empty values or types
            try:
                open_val = float(row['open'])
                high_val = float(row['high'])
                low_val = float(row['low'])
                close_val = float(row['close'])
                volume_val = float(row['volume'])
                amount_val = float(row['amount'])
                adjustflag_val = int(row['adjustflag'])
            except ValueError:
                continue # Skip invalid rows
                
            sql = f"INSERT OR REPLACE INTO stock_kline (date, code, open, high, low, close, volume, amount, adjustflag) VALUES ('{row['date']}', '{row['code']}', {open_val}, {high_val}, {low_val}, {close_val}, {volume_val}, {amount_val}, {adjustflag_val});\n"
            f.write(sql)
            
    print(f"SQL saved to {OUTPUT_SQL_FILE}")

if __name__ == "__main__":
    # For testing, you can set a specific date like "2024-11-26" if today is weekend
    # target_date = "2024-11-26" 
    target_date = get_today_date()
    
    codes = get_constituents()

    bs.login()  # Login before fetching data
    df = fetch_daily_data(codes, target_date)
    bs.logout()
    
    if not df.empty:
        generate_sql(df)
    else:
        print("No data to update.")
        # Create empty file to avoid errors in CI if it expects a file
        open(OUTPUT_SQL_FILE, 'w').close()
